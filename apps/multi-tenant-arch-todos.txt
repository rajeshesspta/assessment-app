Matching

Represent as two lists with correct pairings. Define serialization (e.g., list of {prompt, targetId}) and scoring (full vs. partial credit).
Ordering/Ranking

Capture list of items with required order. Decide if scoring is binary or allows partial credit (Kendall tau, etc.).
Short Answer / Free Response

Store prompt + optional rubric keywords, link scoring to manual review or AI-assisted rubric evaluation.
Essay / Long Form

Similar to short answer but with length expectation and rubric metadata. Ensure attempts capture text blob and workflow for manual scoring.

Numeric Entry

Support exact value or range tolerance; include units metadata if needed.
Hotspot / Image Region

Store background image plus one or more correct polygons/regions. Define how attempts submit coordinates.
Drag-and-Drop

Schema for draggable tokens and drop zones (classification, labeling, sequencing). Determine scoring logic.
Scenario-Based / Coding Tasks

Likely separate module with attachments, evaluation scripts, or test harness metadata.
Each phase should include:

types.ts update
Validation + route changes
Persistence/migration updates
Scoring logic (where applicable)
Seeds/tests (unit + route)
Docs/readme entry



Implementation Plan

Role Hierarchy & Permissions

Add Super Admin → Tenant Admin → Content Author user flow docs (README + maybe docs/domain.md).
Model APIs/DB fields to associate users with roles (tenant admin, content author, learner) if not already tracked; ensure Super Admin can create tenants + delegate admins.
Tenant & User Provisioning

Extend provisioning CLI or routes so Super Admin can create tenants and seed a tenant admin record.
Expose tenant-admin API/CLI to invite content authors and learners; persist their role and cohort memberships.
Item & Assessment Management

Confirm items remain tenant-scoped but shared among that tenant’s content authors.
Adjust item repository/services if we need to record author ownership metadata while keeping shared visibility.
Ensure assessments store allowedAttempts (default 1), item references, and assignment targets (cohort IDs or individual learner IDs).
Cohorts & Assignment Flow

Create cohort entity (name, description, learner IDs, tenantId).
Add APIs for tenant admins/content authors to create/manage cohorts, add learners, and assign assessments to cohorts or specific learners.
When assigning, generate learner-specific assessment entries (or references) with attempt limit metadata.
Attempts & Learner Scope

Update attempt creation to enforce per-learner scoping and respect allowedAttempts.
Ensure responses remain tied to {tenantId, assessmentId, learnerId} and that learners can’t exceed the configured attempt count.
Add validation/tests for cohort-based assignments so only assigned learners can start attempts.
Documentation & Tests

Update README/module docs to reflect the clarified workflow (Super Admin creation, tenant admin responsibilities, cohort usage, attempt limits).
Add Vitest coverage around new APIs (tenant provisioning, cohort assignments, attempt limit enforcement).




multi-tenant - execution plan
==============================
Assessment Content Types
==============================

- [x] Matching — represent as two lists with correct pairings. Need serialization (`{ prompt, targetId }[]`) plus scoring modes (full vs partial credit).
- [x] Ordering / Ranking — capture ordered lists; evaluate if Kendall tau / partial credit is required.
- [x] Short Answer / Free Response — persist prompt + rubric keywords; wire scoring to manual or AI-assisted flows.
- [x] Essay / Long Form — extend short-answer schema with length expectations and rubric metadata; ensure attempts store large text payloads.
- [x] Numeric Entry — support exact answers and tolerance ranges; include optional units metadata.
- [x] Hotspot / Image Region — store base image + polygons, define answer serialization for coordinates.
- [x] Drag-and-Drop — model token + zone schemas (classification, sequencing) and scoring logic.
- [x] Scenario-Based / Coding Tasks — dedicate module for workspace templates, attachments, evaluation scripts.

Each content rollout must include:
- types.ts updates
- Validation + route changes
- Persistence/migrations
- Scoring logic (+ deferred scoring when needed)
- Seeds/tests (unit + route)
- Docs/README updates

==============================
Platform Implementation Checklist
==============================

**Role Hierarchy & Permissions**
- [ ] Document Super Admin → Tenant Admin → Content Author flows inside `docs/domain.md`.
- [ ] Ensure user provisioning APIs persist explicit role arrays; add audits for role promotion/demotion.

**Tenant & User Provisioning**
- [ ] CLI / API endpoint for Super Admins to create tenants and seed tenant admins (control plane will own the metadata; primary API still needs admin records).
- [ ] Tenant-admin API or CLI for inviting content authors + learners, persisting cohort memberships.

**Item & Assessment Management**
- [x] Confirm item ownership metadata requirements (shared bank but track authorship when auditing changes).
- [x] Keep `assessments.allowedAttempts` + assignment targets (cohort IDs or learner IDs) in sync with repositories + migrations.

**Cohorts & Assignment Flow**
- [x] Create/manage cohort APIs (name, description, learner IDs, tenantId).
- [x] Assignment endpoints that attach assessments to cohorts or individuals and hydrate learner attempt quotas.

**Attempts & Learner Scope**
- [x] Attempt creation enforces learner role + cohort membership + allowedAttempts (landed in attempts module).
- [ ] Add regression tests that cover “assigned but exhausted attempts” and “not assigned” scenarios per cohort.

**Documentation & Tests**
- [ ] Update READMEs/docs after each capability ships.
- [x] Maintain Vitest coverage for new APIs (current suite covers tenant registry + BFF loader).

==============================
Control Plane & BFF Integration
==============================

- [x] Control plane API (`apps/control-plane-api`) with SQLite/Cosmos stores, migrations, and `/control/tenant-bundle`.
- [ ] Control plane console (Vite/React) for CRUD + audit UI.
- [ ] Secret rotation workflow that updates Key Vault references and writes audit entries.
- [x] Consumer BFF polling hook (`CONTROL_PLANE_BASE_URL`, `CONTROL_PLANE_API_KEY`, `TENANT_CONFIG_REFRESH_MS`).
- [ ] Alerting/metrics for bundle staleness (`/control/health` + telemetry shipping to dashboards).
- [ ] Webhook/websocket push for tenant bundle updates (reduce polling latency).

**Control Plane Console Security**
- [x] Enforce two-step login between console ↔ proxy (basic credential + OTP challenge) with session cookies guarding `/api/*`.
- [x] Persist OTP challenge/audit events in SQLite (timestamp, actor, action, metadata) and expose log retrieval for compliance.
- [ ] Emit audit records for login, logout, impersonation, and tenant mutations; surface in console UI. _(login + logout covered; tenant mutations still pending UI work)_
- [x] Hash OTP secrets at rest, redact codes in logs, and enforce short-lived sessions with manual revoke support.

==============================
Multi-tenant BFF + Portal Plan
==============================

**Tenant Registry (control plane)**
- [x] Define tenant config schema + REST endpoints.
- [ ] Expose secret management + branding asset upload pathways.

**Runtime Config Loader**
- [x] BFF startup loads bundle + refreshes in background.
- [ ] Consider ETag support to reduce payloads once control plane emits them.

**Tenant-aware Auth**
- [ ] `/auth/switch-tenant` flow for multi-membership users.
- [ ] Enforce actor-role overrides against the tenant’s allowed roles (log + block unauthorized overrides).

**Per-tenant API Proxying**
- [x] Inject `x-tenant-id`, `x-api-key`, and role headers on headless calls.
- [ ] Prevent Super Admin headers from leaking into tenant-scoped requests (double-check middleware once switch-tenant lands).

**Branding & Feature Delivery**
- [x] `/config` returns branding + feature flags.
- [ ] CDN-backed asset pipeline for logos/favicons/backgrounds.

**Portal Boot Flow**
- [x] Boot flow fetches `/config` + `/auth/session` and themes accordingly.
- [ ] Tenant switcher UI for multi-membership accounts.

**Data Isolation & Premium Path**
- [x] Repositories filter by tenantId + logging tags requests.
- [ ] Document premium deployment flow leveraging control-plane bundle export.

**Testing & Rollout**
- [ ] Stage env with multiple tenants hitting control-plane-powered BFF.
- [ ] Feature flag gating for gradual rollout (shared stack first, then premium).

This checklist keeps headless agnostic, lets the shared BFF/portal serve many tenants safely, and still supports separate deployments for premium customers when needed.


Tenant DB Config & Secret Resolution
=====================================

- Problem: some tenants need tenant-specific persistence (Cosmos, remote SQL, or file-backed SQLite). These connection details are sensitive and must not be exposed in plaintext to arbitrary clients.
- Goal: surface per-tenant DB configuration from the Control Plane to trusted runtimes (headless) using secret references and a secure resolution flow.

Design principles
- Never place plaintext credentials in the public tenant bundle.
- Use secret refs (e.g., `secretRef: "kv://tenant-alpha/headless-db"`) in the bundle; trusted runtimes resolve the ref using a configured secret provider.
- Keep the bundle lightweight and idempotent; include `bundleVersion`/`updatedAt` for atomic swaps.

Minimal schema additions (control plane)
- `tenant.headless.db?: { provider: 'sqlite'|'cosmos'|'memory'|'postgres'; connectionStringRef?: string; filePattern?: string; options?: Record<string,string> }`
- Store `db_config_json` in tenant row; persist only refs, not secrets.

BFF behavior
- BFF loads the bundle and exposes `tenant.headless.db` to runtime code but does not resolve secret refs itself by default.
- Optionally the BFF can be configured to resolve secrets for downstream services (only with strict access control).

Headless runtime responsibilities
- Provide a pluggable secret resolver (env|vault|console-proxy) to turn `connectionStringRef` into usable credentials.
- On first tenant use, resolve secrets, initialize tenant DB client, cache the client, and surface health/metrics per-tenant.
- Support rotation: detect changed `updatedAt`/`bundleVersion`, re-resolve refs, and swap connections with graceful handover.

Operational & security notes
- Limit who can set/rotate `db` config in the Control Plane (Super Admin or mapped role).
- Audit every change to DB config and every secret resolution attempt in headless logs (do not log secret contents).
- Provide runbook for emergency rotation and rollback.

Implementation backlog (small, ordered)
- [ ] Schema: add `headless.db` to `apps/control-plane-api/src/tenant-schema.ts` and migrations.
- [ ] Repo: persist `db_config_json` in tenant rows and include it in bundle builder.
- [ ] Console: add Tenant Settings UI to edit `db` refs (Super Admin only) and link to secret manager instructions.
- [ ] BFF: expose `headless.db` in runtime types; optionally add a configurable secret resolver.
- [ ] Headless: implement secret-resolver interface, per-tenant DB client factory, and rotation support.
- [ ] Tests: unit tests for schema parsing, integration test that mocks secret resolver and verifies DB client initialization.
- [ ] Docs: update `docs/control-plane-plan.md` and README entries describing secret refs and resolution.

Next actionable steps (short-term, 2-4 dev days)
- [ ] Implement schema + repository persistence for `headless.db` (Step A).
- [ ] Update BFF runtime types to accept the new shape and surface it to runtime code (Step B).
- [ ] Add a basic secret resolver implementation in headless that reads from env for local dev (Step C).
- [ ] Add integration test for headless that uses env-backed resolver and in-memory SQLite.
- [ ] Control plane console: Persistence tab exposes a DB provider selector (SQLite, Cosmos, etc.) and reveals provider-specific refs/fields before saving.
- [ ] Headless/runtime wiring: consume the tenant-selected provider when instantiating repositories so storage choice actually steers data placement.


Assessment Module Iteration Checklist
====================================

**Iteration 1 – Matching + Ordering foundations**
- Goal: unblock authors with two high-frequency objective item types while exercising the full stack (types → migrations → validation → scoring) before we add heavier free-form tasks. Learners should be able to submit pairs or ordered lists, and the scoring service must support both all-or-nothing and partial-credit modes to cover common classroom rubrics.
- [x] Extend `src/common/types.ts` + migrations for matching/ordering schemas (prompts/targets, canonical order arrays).
- [x] Update item validation/routes + seeds/tests so these types can be authored and fetched per tenant.
- [x] Add scoring helpers (full vs partial for matching, binary + optional partial pairs for ordering) plus unit tests.

**Iteration 2 – Short Answer + Essay**
- [x] Introduce rubric metadata + length expectations in types/migrations and expose via routes.
- [x] Persist attempt text blobs and emit manual scoring/deferred evaluation events.
- [x] Provide seed data + Vitest coverage for rubric presence and scoring workflow.

**Iteration 3 – Numeric + Hotspot + Drag-and-Drop**
- [x] Implement Numeric Entry validation (exact/range) and units metadata support.
- [x] Implement Hotspot scoring (polygon intersection) and selection limits.
- [x] Implement Drag-and-Drop scoring (per-zone/per-token) and ordering evaluation.

**Iteration 4 – Scenario Tasks**
- [x] Scenario tasks: capture workspace templates, attachments, evaluator metadata, scenario answers; emit deferred scoring events.
- [x] Expand scoring/tests to cover scenario workflow expectations.

**Iteration 5 – Cohort Assignments & Attempt polish**
- [x] Finalize cohort assignment APIs (assessment↔cohort links, learner-specific quotas) and migrations.
- [x] Strengthen attempt gating tests (assigned, exhausted, unauthorized) across new content types.
- [x] Update docs/README to summarize shipped assessment capabilities per iteration.

**Iteration 6 – Item Bank & Basic Authoring**
- Goal: Enable Content Authors to manage the shared item bank and create standard objective content.
- [x] UI: Create Item Bank list view (fetch from `GET /items`).
- [x] UI: Implement "Create Item" flow for `MCQ` and `TRUE_FALSE`.
- [x] BFF: Ensure `POST /items` correctly forwards `CONTENT_AUTHOR` roles.
- [x] Validation: Client-side Zod validation for basic item shapes.

**Iteration 7 – Advanced & Subjective Authoring**
- Goal: Expand authoring capabilities to interactive and rubric-based items.
- [x] UI: Implement authoring forms for `MATCHING`, `ORDERING`, and `NUMERIC_ENTRY`.
- [x] UI: Implement `ESSAY` and `SHORT_ANSWER` forms with Rubric editors.
- [x] UI: Add "Sample Answer" and "Keywords" fields for evaluation guidance.

**Iteration 8 – Assessment Builder & Settings**
- Goal: Allow authors to package items into structured assessments with specific delivery rules.
- [x] UI: Create Assessment list and "Create Assessment" flow.
- [x] UI: Item selector component to link items to assessments.
- [x] UI: Configure assessment settings (`allowedAttempts`, `status`).

**Iteration 9 – Preview & Specialized Tasks**
- Goal: Finalize the authoring experience with full-fidelity previews and complex task support.
- [x] UI: Implement "Learner Preview" renderer for all 11 item types.
- [x] UI: Authoring interface for `HOTSPOT` (image upload + point tool).
- [x] UI: Authoring interface for `SCENARIO_TASK` (workspace/attachment config).

**Iteration 10 – Learner Experience: Assessment Player**
- Goal: Provide a focused, interactive environment for learners to complete assessments.
- [x] UI: Implement `AssessmentPlayer` with multi-step navigation.
- [x] UI: Interactive inputs for all 11 item types (MCQ, Matching, Hotspot, etc.).
- [x] BFF: Add `PUT /attempts/:id/responses` for progress saving.

**Iteration 11 – Results & Feedback**
- Goal: Close the loop with immediate feedback and scoring summaries.
- [x] UI: Implement `AttemptResult` view with score breakdown.
- [x] UI: Handle "Pending Evaluation" states for subjective/AI-graded content.
- [x] UI: Add "View Results" flow to the learner dashboard.

**Iteration 12 – Multi-tenant Branding & Customization**
- Goal: Ensure the learner experience respects tenant-specific design tokens.
- [x] UI: Inject `brandPrimary` and `brandAccent` into the Player and Result views.
- [x] UI: Dynamic styling for progress bars, buttons, and selection highlights.

**Iteration 13 – Advanced Assignment & Scheduling UI**
- Goal: Provide a robust interface for managing assessment availability across cohorts.
- [x] UI: Implement "Schedule Assessment" modal with cohort selection.
- [x] UI: Support per-assignment overrides for `allowedAttempts` and `dueDate`.
- [x] UI: View active assignments per cohort in the Assessments dashboard.
- [x] BFF: Update `POST /cohorts/:id/assignments` to handle overrides.

**Iteration 14: Generic Grouping & Metadata**
- Goal: Enable domain-agnostic organization of assessments using collections, tags, and metadata.
- [x] Schema: Add `collection_id`, `tags_json`, and `metadata_json` to the `assessments` table.
- [x] Types: Update `Assessment` interface in `src/common/types.ts`.
- [x] Repository: Update `AssessmentRepository` to persist and retrieve new fields.
- [x] UI: Update `CreateAssessmentModal` to include fields for Collection ID and Tags.
- [x] UI: Update `AssessmentsPage` to display and filter by Collection/Tags.

**Iteration 15: Learner Management & Individual Assignments**
- Goal: Provide a dedicated interface for managing learners and assigning assessments directly to individuals.
- [x] UI: Create `LearnersPage` to list all users with the `LEARNER` role.
- [x] BFF: Add proxy routes for `GET /api/users` and `POST /api/cohorts/assignments/users/:userId`.
- [x] UI: Implement "Assign Assessment" modal for individual learners.
- [x] UI: View active assignments and attempt status per learner.

**Iteration 16: Rater/Reviewer Experience**
- Goal: Enable human review and scoring for subjective items (Essays, Scenario Tasks).
- [ ] UI: Create "Review Queue" for Raters to see pending evaluations.
- [ ] UI: Implement scoring interface with rubric-based grading.
- [ ] BFF: Add proxy routes for evaluation submission.

**Iteration 17: Basic User Management**
- Goal: Enable Tenant Admins to manage the lifecycle of users within their tenant.
- [x] Headless: Implement lean User CRUD (`/users`) with `tenantId` as partition key.
- [x] Headless: Enforce `TENANT_USER_ROLES` validation and email uniqueness per tenant.
- [x] BFF: Implement "Custom Login" persistence and session management.
- [x] UI: Create User Management dashboard for Tenant Admins to manage roles and access.
- [x] UI: Implement user creation, editing, and deactivation flows.

**Iteration 18: Assessment Availability & Scheduling Enforcement**
- Goal: Enforce `availableFrom` and `dueDate` constraints during attempt creation and in the UI.
- [x] Headless: Update `POST /attempts` to validate current time against assignment availability.
- [x] UI: Disable "Start" button in `AssignedAssessmentsList` if the assessment is not yet available or has expired.
- [x] UI: Show "Available on [Date]" or "Expired" status in the learner dashboard.
- [x] BFF: Ensure assignment metadata (dates) is surfaced to the portal.
- [x] Headless: Implement `PUT /cohorts/:id` and `DELETE /cohorts/:id` with proper 404 handling.
- [x] UI: Add delete option for cohorts in `CohortsPage`.

**Iteration 19: Multi-tenant BFF & Portal Plan (Phase 1)**
- Goal: Transition from hardcoded tenant configs to a dynamic registry-backed architecture.
- [ ] BFF: Implement runtime config loader that fetches tenant metadata from the Control Plane.
- [ ] BFF: Add tenant-aware auth flow (subdomain/hint selection).
- [ ] Portal: Implement branding injection from dynamic config (CSS variables).
- [ ] Portal: Add tenant switcher for users with multiple memberships.

**Iteration 20: Learner Dashboard & Overview (MVP)**
- Goal: Provide learners with a personalized dashboard for assigned assessments and progress.
- [x] UI: Create learner dashboard showing assigned assessments with status, due dates, and progress indicators.
- [x] BFF: Add proxy routes for fetching learner assignments and cohort data.
- [x] UI: Implement status badges (Available, In Progress, Expired) and quick access to assessments.

**Iteration 21: Assessment Player & Attempt History**
- Goal: Enable learners to take assessments interactively and review past attempts.
- [ ] UI: Build AssessmentPlayer with timer enforcement, auto-save, and support for all item types.
- [ ] UI: Implement attempt history view with scores, feedback, and retry options.
- [ ] BFF: Add routes for attempt creation, progress saving, and history retrieval.

**Iteration 22: Progress Tracking & Notifications**
- Goal: Enhance learner engagement with visual progress and alerts.
- [ ] UI: Add progress charts (completion rates, scores over time) using attempt data.
- [ ] UI: Implement in-app notifications for due dates and new assignments.
- [ ] BFF: Add notification endpoints and progress aggregation logic.

**Iteration 23: Cohort Insights & Accessibility**
- Goal: Provide group performance insights and ensure accessibility.
- [ ] UI: Add cohort insights view with aggregated stats (privacy-compliant).
- [ ] UI: Implement accessibility features (screen readers, adjustable fonts, keyboard navigation).
- [ ] UI: Ensure responsive design for mobile/tablet devices.

**Iteration 24: Advanced Learner Features**
- Goal: Add multi-language support, AI recommendations, and external integrations.
- [ ] UI: Add multi-language support for UI and assessments based on tenant config.
- [ ] UI: Implement AI-assisted learning recommendations post-assessment.
- [ ] BFF: Add external LMS sync for pulling assignments via webhooks.

**Iteration 25: Feedback & Certificates (Backlog)**
- Goal: Close the feedback loop and provide achievement recognition.
- [ ] UI: Add feedback submission for assessments.
- [ ] UI: Implement certificate/badge generation for completions.
- [ ] BFF: Add feedback storage and certificate generation endpoints.

**Iteration 26: Content Author Dashboard - Quick Actions Bar**
- Goal: Provide immediate entry points for primary workflows to reduce clicks.
- [x] UI: Add Quick Actions Bar with buttons for "Create New Item", "Build Assessment", "Add Cohort".
- [x] UI: Implement modal/form for each action with Zod validation.
- [x] BFF: Ensure role-based access (CONTENT_AUTHOR or TENANT_ADMIN).

**Iteration 27: Content Author Dashboard - Recent Items Summary**
- Goal: Enable quick review of the tenant-wide item bank.
- [ ] UI: Create grid/cards for last 5-10 items (title, kind, status, created date).
- [ ] UI: Add filters (All, Draft, Published) and edit/preview links.
- [ ] BFF: Proxy GET /items with tenant filtering.

**Iteration 28: Content Author Dashboard - Assessments Overview**
- Goal: Monitor assessment assembly and publishing progress.
- [ ] UI: List recent assessments with item count, cohort count, status, and publish controls.
- [ ] UI: Display total assessments metric.
- [ ] BFF: Surface assessment metadata via proxy routes.

**Iteration 29: Content Author Dashboard - Cohorts and Learners Snapshot**
- Goal: Ensure proper grouping and assignment of learners.
- [ ] UI: Cards for top cohorts (name, learner count, assigned assessments).
- [ ] UI: Alerts for learners without roles/cohorts.
- [ ] BFF: Add proxy for cohort/learner data.

**Iteration 30: Content Author Dashboard - Deferred Scoring Queue**
- Goal: Handle pending evaluations promptly.
- [ ] UI: Display count and list of pending evaluations (essays, scenarios).
- [ ] UI: Allow assignment or self-review.
- [ ] BFF: Proxy evaluation endpoints and events.

**Iteration 31: Content Author Dashboard - Analytics Highlights**
- Goal: Provide quick insights into performance.
- [ ] UI: Charts for top items, attempt trends, and weekly metrics.
- [ ] UI: Query reporting endpoints as ANALYTICS_CONSUMER.
- [ ] BFF: Aggregate and proxy analytics data.

**Iteration 32: Content Author Dashboard - Notifications/Alerts**
- Goal: Proactive awareness of issues.
- [ ] UI: Alerts for low item bank, unpublished assessments, failed attempts.
- [ ] UI: Integrate with tenant-scoped notifications.
- [ ] BFF: Add notification fetching and display logic.


