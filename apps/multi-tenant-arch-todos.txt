Matching

Represent as two lists with correct pairings. Define serialization (e.g., list of {prompt, targetId}) and scoring (full vs. partial credit).
Ordering/Ranking

Capture list of items with required order. Decide if scoring is binary or allows partial credit (Kendall tau, etc.).
Short Answer / Free Response

Store prompt + optional rubric keywords, link scoring to manual review or AI-assisted rubric evaluation.
Essay / Long Form

Similar to short answer but with length expectation and rubric metadata. Ensure attempts capture text blob and workflow for manual scoring.

Numeric Entry

Support exact value or range tolerance; include units metadata if needed.
Hotspot / Image Region

Store background image plus one or more correct polygons/regions. Define how attempts submit coordinates.
Drag-and-Drop

Schema for draggable tokens and drop zones (classification, labeling, sequencing). Determine scoring logic.
Scenario-Based / Coding Tasks

Likely separate module with attachments, evaluation scripts, or test harness metadata.
Each phase should include:

types.ts update
Validation + route changes
Persistence/migration updates
Scoring logic (where applicable)
Seeds/tests (unit + route)
Docs/readme entry



Implementation Plan

Role Hierarchy & Permissions

Add Super Admin → Tenant Admin → Content Author user flow docs (README + maybe docs/domain.md).
Model APIs/DB fields to associate users with roles (tenant admin, content author, learner) if not already tracked; ensure Super Admin can create tenants + delegate admins.
Tenant & User Provisioning

Extend provisioning CLI or routes so Super Admin can create tenants and seed a tenant admin record.
Expose tenant-admin API/CLI to invite content authors and learners; persist their role and cohort memberships.
Item & Assessment Management

Confirm items remain tenant-scoped but shared among that tenant’s content authors.
Adjust item repository/services if we need to record author ownership metadata while keeping shared visibility.
Ensure assessments store allowedAttempts (default 1), item references, and assignment targets (cohort IDs or individual learner IDs).
Cohorts & Assignment Flow

Create cohort entity (name, description, learner IDs, tenantId).
Add APIs for tenant admins/content authors to create/manage cohorts, add learners, and assign assessments to cohorts or specific learners.
When assigning, generate learner-specific assessment entries (or references) with attempt limit metadata.
Attempts & Learner Scope

Update attempt creation to enforce per-learner scoping and respect allowedAttempts.
Ensure responses remain tied to {tenantId, assessmentId, learnerId} and that learners can’t exceed the configured attempt count.
Add validation/tests for cohort-based assignments so only assigned learners can start attempts.
Documentation & Tests

Update README/module docs to reflect the clarified workflow (Super Admin creation, tenant admin responsibilities, cohort usage, attempt limits).
Add Vitest coverage around new APIs (tenant provisioning, cohort assignments, attempt limit enforcement).




multi-tenant - execution plan
==============================
Assessment Content Types
==============================

- [ ] Matching — represent as two lists with correct pairings. Need serialization (`{ prompt, targetId }[]`) plus scoring modes (full vs partial credit).
- [ ] Ordering / Ranking — capture ordered lists; evaluate if Kendall tau / partial credit is required.
- [ ] Short Answer / Free Response — persist prompt + rubric keywords; wire scoring to manual or AI-assisted flows.
- [ ] Essay / Long Form — extend short-answer schema with length expectations and rubric metadata; ensure attempts store large text payloads.
- [ ] Numeric Entry — support exact answers and tolerance ranges; include optional units metadata.
- [ ] Hotspot / Image Region — store base image + polygons, define answer serialization for coordinates.
- [ ] Drag-and-Drop — model token + zone schemas (classification, sequencing) and scoring logic.
- [ ] Scenario-Based / Coding Tasks — dedicate module for workspace templates, attachments, evaluation scripts.

Each content rollout must include:
- types.ts updates
- Validation + route changes
- Persistence/migrations
- Scoring logic (+ deferred scoring when needed)
- Seeds/tests (unit + route)
- Docs/README updates

==============================
Platform Implementation Checklist
==============================

**Role Hierarchy & Permissions**
- [ ] Document Super Admin → Tenant Admin → Content Author flows inside `docs/domain.md`.
- [ ] Ensure user provisioning APIs persist explicit role arrays; add audits for role promotion/demotion.

**Tenant & User Provisioning**
- [ ] CLI / API endpoint for Super Admins to create tenants and seed tenant admins (control plane will own the metadata; primary API still needs admin records).
- [ ] Tenant-admin API or CLI for inviting content authors + learners, persisting cohort memberships.

**Item & Assessment Management**
- [ ] Confirm item ownership metadata requirements (shared bank but track authorship when auditing changes).
- [ ] Keep `assessments.allowedAttempts` + assignment targets (cohort IDs or learner IDs) in sync with repositories + migrations.

**Cohorts & Assignment Flow**
- [ ] Create/manage cohort APIs (name, description, learner IDs, tenantId).
- [ ] Assignment endpoints that attach assessments to cohorts or individuals and hydrate learner attempt quotas.

**Attempts & Learner Scope**
- [x] Attempt creation enforces learner role + cohort membership + allowedAttempts (landed in attempts module).
- [ ] Add regression tests that cover “assigned but exhausted attempts” and “not assigned” scenarios per cohort.

**Documentation & Tests**
- [ ] Update READMEs/docs after each capability ships.
- [x] Maintain Vitest coverage for new APIs (current suite covers tenant registry + BFF loader).

==============================
Control Plane & BFF Integration
==============================

- [x] Control plane API (`apps/control-plane-api`) with SQLite/Cosmos stores, migrations, and `/control/tenant-bundle`.
- [ ] Control plane console (Vite/React) for CRUD + audit UI.
- [ ] Secret rotation workflow that updates Key Vault references and writes audit entries.
- [x] Consumer BFF polling hook (`CONTROL_PLANE_BASE_URL`, `CONTROL_PLANE_API_KEY`, `TENANT_CONFIG_REFRESH_MS`).
- [ ] Alerting/metrics for bundle staleness (`/control/health` + telemetry shipping to dashboards).
- [ ] Webhook/websocket push for tenant bundle updates (reduce polling latency).

==============================
Multi-tenant BFF + Portal Plan
==============================

**Tenant Registry (control plane)**
- [x] Define tenant config schema + REST endpoints.
- [ ] Expose secret management + branding asset upload pathways.

**Runtime Config Loader**
- [x] BFF startup loads bundle + refreshes in background.
- [ ] Consider ETag support to reduce payloads once control plane emits them.

**Tenant-aware Auth**
- [ ] `/auth/switch-tenant` flow for multi-membership users.
- [ ] Enforce actor-role overrides against the tenant’s allowed roles (log + block unauthorized overrides).

**Per-tenant API Proxying**
- [x] Inject `x-tenant-id`, `x-api-key`, and role headers on headless calls.
- [ ] Prevent Super Admin headers from leaking into tenant-scoped requests (double-check middleware once switch-tenant lands).

**Branding & Feature Delivery**
- [x] `/config` returns branding + feature flags.
- [ ] CDN-backed asset pipeline for logos/favicons/backgrounds.

**Portal Boot Flow**
- [x] Boot flow fetches `/config` + `/auth/session` and themes accordingly.
- [ ] Tenant switcher UI for multi-membership accounts.

**Data Isolation & Premium Path**
- [x] Repositories filter by tenantId + logging tags requests.
- [ ] Document premium deployment flow leveraging control-plane bundle export.

**Testing & Rollout**
- [ ] Stage env with multiple tenants hitting control-plane-powered BFF.
- [ ] Feature flag gating for gradual rollout (shared stack first, then premium).

This checklist keeps headless agnostic, lets the shared BFF/portal serve many tenants safely, and still supports separate deployments for premium customers when needed.

